<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Project</title>
    <style type="text/css">
        canvas {
			border: 1px solid grey;
        }
    </style>
  </head>
    
  <body>
    
    <canvas id="canvas" width="600" height="400"></canvas>
    
    <script type="text/javascript">
      //http://stackoverflow.com/questions/21089959/detecting-collision-of-rectangle-with-circle-in-html5-canvas
      // Gets a handle to the element with id canvasOne. Ian
      var canvas = document.getElementById("canvas");
      // Get a 2D context for the canvas.
      var ctx = canvas.getContext("2d");
     
	  var gameLevel = 1;
	  var randomX;
	  var slotX;
	  var stopLoop = false;
	  
      //square-Player-----------------------------------------------------------------
      var square = {
         x: 285,
         y: 370,
		 w: 30,
		 h: 30,
           
         draw: function(){
            ctx.fillStyle = "rgb(255,0,0)";
            ctx.fillRect(this.x, this.y, this.w, this.h);
         },
		 
		 complete: function(){
			if(this.x == slotX && this.y == 0){
				alert("Level: " + gameLevel + " Complete!");
				this.x = 285;
				this.y = 370;
				ctx.fillRect(this.x, this.y, this.w, this.h);
				rectangle.createRandomSlotPos();
				
				if(gameLevel == 5){
					stopLoop = true;
					alert("Game Complete!");
				}
				else
				{
					gameLevel++;
				}
			}
		 }
       };
        
	  //rectangle at the top----------------------------------------------------------
	  var rectangle = {
		x: 0,
		y: 0,
		
		//draw the rectangle across the top
		draw: function (){
			ctx.fillStyle = "rgb(0,150,0)";
            ctx.fillRect(this.x, this.y, canvas.width, 30);
		},
		
		createRandomSlotPos: function(){
			randomX = Math.floor((Math.random() * 114) + 0);
			slotX = (randomX * 5);
		},
		//create a gap of the same size as the player square in the rectangle at the top
		createSlot: function(){
			ctx.clearRect(slotX, 0, 30, 30);
		}
	  }
     
	  //ball---------------------------------------------------------------------
	  function Ball(xpos,ypos, vx, vy) {
		this.x = xpos;
		this.y = ypos;
		this.r = 10;
		this.vx = vx;
		this.vy = vy;
        
        this.draw = function(){
          ctx.fillStyle = "rgb(200,10,500)";
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.r, 0, 2 * Math.PI);
          ctx.fill();
          ctx.closePath();
        };
        
        this.moveBall = function(){
          if(this.x > canvas.width - this.r || this.x < this.r){
              this.vx = -this.vx;
          }

          if(this.y > canvas.height - this.r || this.y < 30 + this.r){
              this.vy = -this.vy;
          }

          // Update the y location.
          this.x += this.vx;
          this.y += this.vy;
        };
		
		this.colliding = function(square){
			var distX = Math.abs((this.x + this.vx) - (square.x));
			var distY = Math.abs((this.y + this.vy) - (square.y));
			
		    if (distX > ((square.w/2) + this.r)){
				return false;
			}
			if(distY > ((square.h/2) + this.r)){
				return false;
			}
			if (distX <= this.r){
				console.log("collision");
				this.vx -= this.vx;
				return true;
			} 
			if (distY <= this.r){
				console.log("collision");
				this.vy -= this.vy;
				return true;
			}
		 };
	  }
	  
	  var balls = [];
	  
	  //KEYBOARD----------------------------------------------------------------------
      // Add an event listener to the keypress event.
      window.addEventListener("keypress", function(event) { 
        // Just log the event to the console.
        console.log(event);
        
		//check that the player square cannot leave the canvas
        if(event.keyCode == 119 && square.y > 30 || (event.keyCode == 119 && square.y <= 30 && square.x == slotX)){//w key -------------------
			square.y -= 5;
        }
        else if(event.keyCode == 115 && square.y + 30 < canvas.height){//s key -------------------
			square.y += 5;
        }
        else if(event.keyCode == 97 && square.x > 0){//a key -------------------
			if(event.keyCode == 97 && square.y < 30 && square.x == slotX){
				square.x += 5;
			}
			square.x -= 5;
        }
        else if(event.keyCode == 100 && square.x + 30 < canvas.width){//d key -------------------
            if(event.keyCode == 100 && square.y < 30 && square.x == slotX){
				square.x -= 5;
			}
			square.x += 5;
        }
      });
  
	  //game loop---------------------------------------------------------------------
	  function step(t){
        //console.log(t);
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
		for (var i = 0; i < gameLevel; i++){
		  balls[i].draw();
		  balls[i].moveBall();
		  if(balls[i].colliding(square)){
			stopLoop = true;
			alert("Game Over!");
		  }	  
        }
		
		//draw the rectangle at the top and clear space for the square
		rectangle.draw();
		rectangle.createSlot();
		
		square.complete();

		//draw the player square
		ctx.fillStyle = "rgb(255,0,0)";
        ctx.fillRect((square.x), (square.y), square.w, square.h);	
        
		if(stopLoop == false){
			window.requestAnimationFrame(step);
		}
	  }
	  
      //initialyze--------------------------------------------------------------------
	  function init(){
     	 //draw the rectangle at the top create a slot and draw the player square
		 rectangle.draw();
		 rectangle.createRandomSlotPos();
		 rectangle.createSlot();
		 
         square.draw();
		 
		for(var i = 0; i < 5; i++){
          balls[i] = new Ball((Math.random() * 500) + 41, (Math.random() * 200) + 41, (Math.random() * 2) + 1, (Math.random() * 3) + 1);
        }
       
		for (var i = 0; i < gameLevel; i++){
          balls[i].draw();
        }
		
		step();
      }
      init(); // call the init function
      
	  function restartGame(){
		stopLoop = false;
		gameLevel = 1;
		init();
		square.x = 285;
		square.y = 370;
		square.draw();
	  }
    </script>
      
	<div>
	  <button onclick="restartGame()">Restart</button>
	</div>
  </body>
</html>